!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports.JcampConverter=t():e.JcampConverter=t()}("undefined"!=typeof self?self:this,function(){return function(e){var t={};function n(i){if(t[i])return t[i].exports;var r=t[i]={i:i,l:!1,exports:{}};return e[i].call(r.exports,r,r.exports,n),r.l=!0,r.exports}return n.m=e,n.c=t,n.d=function(e,t,i){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(n.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)n.d(i,r,function(t){return e[t]}.bind(null,r));return i},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=0)}([function(e,t,n){"use strict";function i(){const e=/[, \t]+/,t=["TIC",".RIC","SCANNUMBER"];function n(e){let t=[];for(let n=0;n<e.length;n++)t.push(parseFloat(e[n]));return t}class i{}const r={keepRecordsRegExp:/^$/,canonicDataLabels:!0,xy:!1,withoutXY:!1,chromatogram:!1,keepSpectra:!1,noContour:!1,nbContourLevels:7,noiseMultiplier:5,profiling:!1};function a(e){return e.toLowerCase().replace(/[^a-z0-9]/g,"")}function s(e){return-1!==t.indexOf(e)}function l(e,t){if(t.xFactor||(t.xFactor=1),t.yFactor||(t.yFactor=1),t.observeFrequency&&t.xUnit&&"HZ"===t.xUnit.toUpperCase()&&(t.xUnit="PPM",t.xFactor=t.xFactor/t.observeFrequency,t.firstX=t.firstX/t.observeFrequency,t.lastX=t.lastX/t.observeFrequency,t.deltaX=t.deltaX/t.observeFrequency),t.shiftOffsetVal){let e=t.firstX-t.shiftOffsetVal;t.firstX=t.firstX-e,t.lastX=t.lastX-e}}function o(e){let t=(e=e.sort(f)).length;return e[Math.floor(t/2)]}function f(e,t){return e-t}function p(e,t){let n=e.yFactor,i=e.deltaX;e.isXYdata=!0;let r=[];e.data=[r];let a,s=e.firstX,l=e.firstY,o=!1,f=0;for(;f<t.length;f++)if(13===(a=t.charCodeAt(f))||10===a)o=!0;else if(o)break;let p=!0,u=!1,c=!1,h=0,g=!1,d=!1,m=0,y=0,F=!1,x=!1,b=!1,A=0;for(;f<=t.length;f++)if(a=f===t.length?13:t.charCodeAt(f),d)13!==a&&10!==a||(p=!0,d=!1);else if(a<=57&&a>=48)x=!0,A>0?m+=(a-48)/Math.pow(10,A++):(m*=10,m+=a-48);else if(44===a||46===a)x=!0,A++;else{if(x){if(p)p=!1,c&&(b=!0);else if(b)b=!1;else{u?(h=F?0-m:m,c=!0,u=!1):g||(y=F?0-m:m);let e=g?m-1:1;for(let t=0;t<e;t++)c?l+=h:l=y,r.push(s),r.push(l*n),s+=i}F=!1,m=0,A=0,x=!1,g=!1}if(a<74&&a>63)x=!0,c=!1,m=a-64;else if(a>96&&a<106)x=!0,c=!1,m=a-96,F=!0;else if(115===a)x=!0,g=!0,m=9;else if(a>82&&a<91)x=!0,g=!0,m=a-82;else if(a>73&&a<83)x=!0,u=!0,m=a-73;else if(a>105&&a<115)x=!0,u=!0,m=a-105,F=!0;else if(36===a&&36===t.charCodeAt(f+1))x=!0,d=!0;else if(37===a)x=!0,u=!0,m=0,F=!1;else if(45===a){let e=t.charCodeAt(f+1);(e>=48&&e<=57||44===e||46===e)&&(x=!0,p||(c=!1),F=!0)}else 13!==a&&10!==a||(p=!0,d=!1)}}function u(e,t){let n,i=/(\(+|\)+|<+|>+|\s+)/g;e.isXYAdata=!0;let r=[];e.data=[r];let a=t.split(/,? *,?[;\r\n]+ */);for(let e=1;e<a.length;e++)n=a[e].trim().replace(i,"").split(","),r.push(parseFloat(n[0])),r.push(parseFloat(n[1]))}function c(e,t,n){let i,r=/\$\$.*/,a=/[,\t ]+/;e.isPeaktable=!0;let s=[];e.data=[s];let l=t.split(/,? *,?[;\r\n]+ */);for(let t=1;t<l.length;t++)if((i=l[t].trim().replace(r,"").split(a)).length%2==0)for(let t=0;t<i.length;t+=2)s.push(parseFloat(i[t])*e.xFactor),s.push(parseFloat(i[t+1])*e.yFactor);else n.logs.push("Format error: ".concat(i))}return function(f,h){let g,d,m,y,F,x,b=!(h=Object.assign({},r,h)).withoutXY,A=Date.now(),X={},T={};T.profiling=!!h.profiling&&[],T.logs=[];let O=[];T.spectra=O,T.info={};let v=new i;if("string"!=typeof f)throw new TypeError("the JCAMP should be a string");T.profiling&&T.profiling.push({action:"Before split to LDRS",time:Date.now()-A}),m=f.split(/[\r\n]+##/),T.profiling&&T.profiling.push({action:"Split to LDRS",time:Date.now()-A}),m[0]&&(m[0]=m[0].replace(/^[\r\n ]*##/,""));for(let t=0;t<m.length;t++){let r;(y=(g=m[t]).indexOf("="))>0?(r=g.substring(0,y),d=g.substring(y+1).trim()):(r=g,d="");let o=r.replace(/[_ -]/g,"").toUpperCase();if("DATATABLE"===o&&(-1===(F=d.indexOf("\n"))&&(F=d.indexOf("\r")),F>0)){let e=-1,t=-1;if((x=d.substring(0,F).split(/[ ,;\t]+/))[0].indexOf("++")>0){let n=x[0].replace(/.*\(([a-zA-Z0-9]+)\+\+.*/,"$1"),i=x[0].replace(/.*\.\.([a-zA-Z0-9]+).*/,"$1");e=X.symbol.indexOf(n),t=X.symbol.indexOf(i)}-1===e&&(e=0),-1===t&&(t=0),X.first&&(X.first.length>e&&(v.firstX=X.first[e]),X.first.length>t&&(v.firstY=X.first[t])),X.last&&(X.last.length>e&&(v.lastX=X.last[e]),X.last.length>t&&(v.lastY=X.last[t])),X.vardim&&X.vardim.length>e&&(v.nbPoints=X.vardim[e]),X.factor&&(X.factor.length>e&&(v.xFactor=X.factor[e]),X.factor.length>t&&(v.yFactor=X.factor[t])),X.units&&(X.units.length>e&&(v.xUnit=X.units[e]),X.units.length>t&&(v.yUnit=X.units[t])),v.datatable=x[0],x[1]&&x[1].indexOf("PEAKS")>-1?o="PEAKTABLE":x[1]&&(x[1].indexOf("XYDATA")||x[0].indexOf("++")>0)&&(o="XYDATA",v.deltaX=(v.lastX-v.firstX)/(v.nbPoints-1))}if("XYDATA"!==o)if("PEAKTABLE"!==o)if("PEAKASSIGNMENTS"!==o){if("TITLE"===o)v.title=d;else if("DATATYPE"===o)v.dataType=d,d.indexOf("nD")>-1&&(T.twoD=!0);else if("NTUPLES"===o)d.indexOf("nD")>-1&&(T.twoD=!0);else if("XUNITS"===o)v.xUnit=d;else if("YUNITS"===o)v.yUnit=d;else if("FIRSTX"===o)v.firstX=parseFloat(d);else if("LASTX"===o)v.lastX=parseFloat(d);else if("FIRSTY"===o)v.firstY=parseFloat(d);else if("LASTY"===o)v.lastY=parseFloat(d);else if("NPOINTS"===o)v.nbPoints=parseFloat(d);else if("XFACTOR"===o)v.xFactor=parseFloat(d);else if("YFACTOR"===o)v.yFactor=parseFloat(d);else if("MAXX"===o)v.maxX=parseFloat(d);else if("MINX"===o)v.minX=parseFloat(d);else if("MAXY"===o)v.maxY=parseFloat(d);else if("MINY"===o)v.minY=parseFloat(d);else if("DELTAX"===o)v.deltaX=parseFloat(d);else if(".OBSERVEFREQUENCY"===o||"$SFO1"===o)v.observeFrequency||(v.observeFrequency=parseFloat(d));else if(".OBSERVENUCLEUS"===o)v.xType||(T.xType=d.replace(/[^a-zA-Z0-9]/g,""));else if("$SFO2"===o)T.indirectFrequency||(T.indirectFrequency=parseFloat(d));else if("$OFFSET"===o)T.shiftOffsetNum=0,v.shiftOffsetVal||(v.shiftOffsetVal=parseFloat(d));else if("$REFERENCEPOINT"===o);else if("VARNAME"===o)X.varname=d.split(e);else if("SYMBOL"===o)X.symbol=d.split(e);else if("VARTYPE"===o)X.vartype=d.split(e);else if("VARFORM"===o)X.varform=d.split(e);else if("VARDIM"===o)X.vardim=n(d.split(e));else if("UNITS"===o)X.units=d.split(e);else if("FACTOR"===o)X.factor=n(d.split(e));else if("FIRST"===o)X.first=n(d.split(e));else if("LAST"===o)X.last=n(d.split(e));else if("MIN"===o)X.min=n(d.split(e));else if("MAX"===o)X.max=n(d.split(e));else if(".NUCLEUS"===o)T.twoD&&(T.yType=d.split(e)[0]);else if("PAGE"===o){v.page=d.trim(),v.pageValue=parseFloat(d.replace(/^.*=/,"")),v.pageSymbol=v.page.replace(/[=].*/,"");let e=X.symbol.indexOf(v.pageSymbol),t="";X.units&&X.units[e]&&(t=X.units[e]),T.indirectFrequency&&"PPM"!==t&&(v.pageValue/=T.indirectFrequency)}else"RETENTIONTIME"===o?v.pageValue=parseFloat(d):s(o)?v[a(o)]=d:"SAMPLEDESCRIPTION"===o&&(v.sampleDescription=d);if(o.match(h.keepRecordsRegExp)){let e=h.canonicDataLabels?o:r;T.info[e]?(Array.isArray(T.info[e])||(T.info[e]=[T.info[e]]),T.info[e].push(d.trim())):T.info[e]=d.trim()}}else b&&(d.match(/.*(XYA).*/)&&u(v,d),O.push(v),v=new i);else b&&(l(0,v),c(v,d,T),O.push(v),v=new i);else b&&(l(0,v),d.match(/.*\+\+.*/)?(v.deltaX||(v.deltaX=(v.lastX-v.firstX)/(v.nbPoints-1)),p(v,d)):c(v,d,T),O.push(v),v=new i)}if(T.profiling&&T.profiling.push({action:"Finished parsing",time:Date.now()-A}),Object.keys(X).length>0){let e=[],t=Object.keys(X);for(let n=0;n<t.length;n++){let i=t[n],r=X[i];for(let t=0;t<r.length;t++)e[t]||(e[t]={}),e[t][i]=r[t]}T.ntuples=e}if(T.twoD&&b&&(function(e,t){let n=function(e){let t=e[0].data[0][0],n=t,i=e.length,r=e[0].data[0].length/2,a=new Array(i);for(let s=0;s<i;s++){a[s]=new Array(r);let i=e[s].data[0];for(let e=0;e<r;e++){let r=i[2*e+1];a[s][e]=r,r<t&&(t=r),r>n&&(n=r)}}const s=e[0].data[0][0],l=e[0].data[0][e[0].data[0].length-2],f=e[0].pageValue,p=e[i-1].pageValue;if(s>l)for(let e of a)e.reverse();return f>p&&a.reverse(),{z:a,minX:Math.min(s,l),maxX:Math.max(s,l),minY:Math.min(f,p),maxY:Math.max(f,p),minZ:t,maxZ:n,noise:o(a[0].map(Math.abs))}}(e.spectra);t.noContour||(e.contourLines=function(e,t){let n,i,r,a,s,l,o,f,p,u,c,h,g,d=e.noise,m=e.z,y=m.length,F=m[0].length,x=e.minX,b=(e.maxX-x)/(F-1),A=e.minY,X=(e.maxY-A)/(y-1),T=e.minZ,O=e.maxZ,v=2*t.nbContourLevels,E=new Array(v);for(let e=0;e<v;e++){let v={};E[e]=v;let S=e%2,M=(O-t.noiseMultiplier*d)*Math.exp((e>>1)-t.nbContourLevels);g=0===S?M+t.noiseMultiplier*d:0-M-t.noiseMultiplier*d;let w=[];if(v.zValue=g,v.lines=w,!(g<=T||g>=O))for(let e=0;e<y-1;e++){let t=m[e],d=m[e+1];for(let m=0;m<F-1;m++)n=t[m],i=t[m+1],r=d[m],a=d[m+1],o=r>g,f=a>g,(s=n>g)!=(l=i>g)&&s!==o&&(p=m+(g-n)/(i-n),u=e,c=m,h=e+(g-n)/(r-n),w.push(p*b+x),w.push(u*X+A),w.push(c*b+x),w.push(h*X+A)),f!==l&&f!==o&&(p=m+1,u=e+1-(g-a)/(i-a),c=m+1-(g-a)/(r-a),h=e+1,w.push(p*b+x),w.push(u*X+A),w.push(c*b+x),w.push(h*X+A)),l!==o&&(p=(m+1-(g-i)/(r-i))*b+x,u=(e+(g-i)/(r-i))*X+A,l!==s&&(c=m+1-(g-i)/(n-i),h=e,w.push(p),w.push(u),w.push(c*b+x),w.push(h*X+A)),o!==s&&(c=m,h=e+1-(g-r)/(n-r),w.push(p),w.push(u),w.push(c*b+x),w.push(h*X+A)),l!==f&&(c=m+1,h=e+(g-i)/(a-i),w.push(p),w.push(u),w.push(c*b+x),w.push(h*X+A)),o!==f&&(c=m+(g-r)/(a-r),h=e+1,w.push(p),w.push(u),w.push(c*b+x),w.push(h*X+A)))}}return{minX:e.minX,maxX:e.maxX,minY:e.minY,maxY:e.maxY,segments:E}}(n,t),delete n.z),e.minMax=n}(T,h),T.profiling&&T.profiling.push({action:"Finished countour plot calculation",time:Date.now()-A}),h.keepSpectra||delete T.spectra),h.chromatogram&&(h.xy=!0),h.xy&&b&&O.length>0)for(let e=0;e<O.length;e++)if((v=O[e]).data.length>0)for(let e=0;e<v.data.length;e++){let t=v.data[e],n={x:new Array(t.length/2),y:new Array(t.length/2)};for(let e=0;e<t.length;e+=2)n.x[e/2]=t[e],n.y[e/2]=t[e+1];v.data[e]=n}return h.chromatogram&&(T.spectra.length>1?function(e){let n=e.spectra,i=n.length,r={times:new Array(i),series:{ms:{dimension:2,data:new Array(i)}}},s=[];for(let e=0;e<t.length;e++){let l=a(t[e]);n[0][l]&&(s.push(l),r.series[l]={dimension:1,data:new Array(i)})}for(let e=0;e<i;e++){let t=n[e];r.times[e]=t.pageValue;for(let n=0;n<s.length;n++)r.series[s[n]].data[e]=parseFloat(t[s[n]]);t.data&&(r.series.ms.data[e]=[t.data[0].x,t.data[0].y])}e.chromatogram=r}(T):function(e){let t=e.spectra[0].data[0];e.chromatogram={times:t.x.slice(),series:{intensity:{dimension:1,data:t.y.slice()}}}}(T),T.profiling&&T.profiling.push({action:"Finished chromatogram calculation",time:Date.now()-A})),T.profiling&&T.profiling.push({action:"Total time",time:Date.now()-A}),T}}let r=i();let a,s={};e.exports={convert:function(e,t,n){return"boolean"==typeof t&&(n=t,t={}),n?function(e,t){return a||function(){let e=URL.createObjectURL(new Blob(["var getConverter =".concat(i.toString(),";var convert = getConverter(); onmessage = function (event) { var data = JSON.parse(event.data); postMessage(JSON.stringify({stamp: data.stamp, output: convert(data.input, data.options)})); };")],{type:"application/javascript"}));a=new Worker(e),URL.revokeObjectURL(e),a.addEventListener("message",function(e){let t=JSON.parse(e.data),n=t.stamp;s[n]&&s[n](t.output)})}(),new Promise(function(n){let i="".concat(Date.now()).concat(Math.random());s[i]=n,a.postMessage(JSON.stringify({stamp:i,input:e,options:t}))})}(e,t):r(e,t)},createTree:function(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};const{flatten:n=!1}=t;if("string"!=typeof e)throw new TypeError("the JCAMP should be a string");let i,r=e.split(/[\r\n]+/),a=[],s=[],l=[],o=0,f=e.includes("## ");for(let e=0;e<r.length;e++){let t=r[e],n=f?t.replace(/ /g,""):t;if("##NTUPLES"===n.substring(0,9)&&o++,"##TITLE"===n.substring(0,7)){let l=[n.substring(8).trim()];for(let t=e+1;t<r.length&&!r[t].startsWith("##");t++)l.push(r[t].trim());s.push({title:l.join("\n"),jcamp:"".concat(t,"\n"),children:[]}),i=s[s.length-1],a.push(i)}else if("##END"===n.substring(0,5)&&0===o){i.jcamp+="".concat(t,"\n");let e=s.pop();0!==s.length?(i=s[s.length-1]).children.push(e):(i=void 0,l.push(e))}else if(i&&i.jcamp){i.jcamp+="".concat(t,"\n");let e=n.match(/^##(.*?)=(.+)/);e&&"DATATYPE"===e[1].replace(/[ _-]/g,"").toUpperCase()&&(i.dataType=e[2].trim())}"##END"===n.substring(0,5)&&o>0&&o--}return n?(a.forEach(e=>{e.children=void 0}),a):l}}}])});